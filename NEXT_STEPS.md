# Next Steps: OAuth2 Setup for Drive Uploads

Your project has been updated to support OAuth2 authentication for Google Drive uploads! ğŸ‰

## What Changed?

### âœ… New Files Added

1. **`src/authorize.js`** - OAuth2 authorization script
2. **`src/driveHelper.js`** - Drive upload utilities
3. **`docs/OAUTH2_SETUP.md`** - Complete OAuth2 setup guide
4. **`docs/DUAL_AUTH_GUIDE.md`** - Explanation of dual auth system
5. **`.env.example`** - Environment variable template

### âœ… Updated Files

1. **`package.json`** - Added googleapis, dotenv, open packages
2. **`.gitignore`** - Excludes OAuth2 credentials and .env
3. **`README.md`** - Updated with OAuth2 setup info
4. **`SETUP.md`** - Added OAuth2 instructions
5. **`5.Continous_LST_Day_Export_versioned_auto.js`** - Removed ee.batch Drive export
6. **`.github/workflows/lst-processing.yml`** - Added OAuth2 env vars

## Quick Start (5 Minutes)

### 1. Install New Dependencies

```bash
npm install
```

This installs:
- `googleapis` - For Google Drive API
- `dotenv` - For environment variables
- `open` - For browser authorization

### 2. Create OAuth2 Credentials

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Select project: `ee-corfobbppciren2023`
3. Click **"+ CREATE CREDENTIALS" â†’ "OAuth client ID"**
4. Application type: **"Desktop app"**
5. Name: `LST Drive Uploader`
6. Click **"CREATE"**
7. Download the JSON file
8. Save as: `credentials/oauth2-credentials.json`

### 3. Authorize the Application

```bash
npm run authorize
```

This will:
- Open your browser
- Ask you to sign in with **corfobbppciren2023@gmail.com**
- Grant Drive permissions
- Generate a refresh token
- Save it to `.env`

### 4. Share Drive Folder

1. Log in to Google Drive as **corfobbppciren2023@gmail.com**
2. Find or create folder: **"LST VIIRS"**
3. Right-click â†’ Share
4. Add: `gee-automation@ee-corfobbppciren2023.iam.gserviceaccount.com`
5. Give **"Editor"** permissions
6. Click **"Share"**

### 5. Test It

```bash
npm start
```

Should see:
```
âœ“ Earth Engine initialized successfully
Using OAuth2 credentials from file
Found existing folder: LST VIIRS
```

## For GitHub Actions

### Add These Secrets

Go to: **Repository â†’ Settings â†’ Secrets and variables â†’ Actions**

Add:

| Secret Name | Value | Where to Get |
|------------|-------|--------------|
| `EE_PRIVATE_KEY` | Service account JSON | Copy entire `credentials/service-account-key.json` |
| `OAUTH2_CREDENTIALS_JSON` | OAuth2 client JSON | Copy entire `credentials/oauth2-credentials.json` |
| `DRIVE_REFRESH_TOKEN` | Refresh token | From your `.env` file (starts with `1//`) |

## File Structure

```
CORFO_23BP_Valparaiso_HS/
â”œâ”€â”€ credentials/
â”‚   â”œâ”€â”€ service-account-key.json        # âœ… Already have
â”‚   â””â”€â”€ oauth2-credentials.json         # âš ï¸ Need to create
â”œâ”€â”€ .env                                 # âš ï¸ Generated by npm run authorize
â”œâ”€â”€ .env.example                         # âœ… Template provided
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ authorize.js                     # âœ… New OAuth2 setup script
â”‚   â”œâ”€â”€ driveHelper.js                   # âœ… New Drive utilities
â”‚   â””â”€â”€ ...
â””â”€â”€ docs/
    â”œâ”€â”€ OAUTH2_SETUP.md                  # âœ… Detailed setup guide
    â”œâ”€â”€ DUAL_AUTH_GUIDE.md               # âœ… Architecture explanation
    â””â”€â”€ ...
```

## Detailed Guides

- ğŸ“– [OAuth2 Setup Guide](docs/OAUTH2_SETUP.md) - Step-by-step OAuth2 setup
- ğŸ“– [Dual Auth Guide](docs/DUAL_AUTH_GUIDE.md) - Why we use two auth methods
- ğŸ“– [Service Account Guide](docs/OAUTH_VS_SERVICE_ACCOUNT.md) - Service account setup

## Common Issues

### "oauth2-credentials.json not found"

**Solution:** Download OAuth2 client credentials from Google Cloud Console

### "DRIVE_REFRESH_TOKEN is not set"

**Solution:** Run `npm run authorize` to generate the token

### "Token has been expired or revoked"

**Solution:**
1. Go to https://myaccount.google.com/permissions
2. Revoke access to "LST Drive Uploader"
3. Run `npm run authorize` again

### "Insufficient Permission"

**Solution:** Share "LST VIIRS" Drive folder with your service account email

## Security Checklist

- [ ] `.gitignore` excludes `credentials/` folder
- [ ] `.gitignore` excludes `.env` file
- [ ] OAuth2 credentials are in GitHub Secrets
- [ ] Refresh token is in GitHub Secrets
- [ ] Service account key is in GitHub Secrets

## What Happens Now?

### Current Behavior

1. âœ… Earth Engine exports work (service account)
2. âœ… Tasks saved to `lst_tasks.json` (committed to Git for tracking)
3. âš ï¸ Drive uploads **removed** from ee.batch (doesn't work with OAuth2 in Node.js)
4. ğŸ”œ Next: Implement post-export download â†’ Drive upload flow

### How Task Tracking Works

When you run `npm start`:
1. Exports are started in Earth Engine
2. Task info is saved to `lst_tasks.json`
3. **In GitHub Actions**: File is automatically committed and pushed
4. **Locally**: You can commit it manually with `git add lst_tasks.json && git commit -m "Update tasks"`

This allows you to:
- Track which years have been exported
- Monitor task IDs for completion status
- Share task status across workflow runs (no artifact expiration!)

### Future Enhancement (Optional)

You can add a separate script to:
1. Read tasks from `lst_tasks.json`
2. Wait for EE export tasks to complete
3. Download the assets as GeoTIFF
4. Upload to Drive using OAuth2

This would be similar to your other project's `download-and-upload.js`.

## Questions?

Check the guides:
- [OAuth2 Setup](docs/OAUTH2_SETUP.md)
- [Dual Authentication](docs/DUAL_AUTH_GUIDE.md)
- [Main Setup](SETUP.md)

---

**Ready to go!** Run `npm run authorize` to get started. ğŸš€
